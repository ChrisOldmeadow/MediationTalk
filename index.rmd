---
title: "Mediation"
subtitle: "<br><span style = 'font-size: 50%;'> Part 4 of Summary of the Harvard Workshop on Causal Modelling</span>"
author: "Chris Oldmeadow"
institute: "CReDITSS, HMRI"
date: "`r Sys.Date()`"
output:
  xaringan::moon_reader:
    css: ["default", "fonts.css", "custom.css"]
    lib_dir: libs
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
---
```{r setup, include=FALSE, fig.retina = 3}
options(htmltools.dir.version = FALSE)
library(knitr)
#knitr::opts_chunk$set(cache = TRUE, warning = FALSE, message = FALSE, dpi = 180)
library(ggplot2)
#library(silgelib)
library(emo)
library(dagitty)
library(ggdag)

```



# Mediation

.pull-left[
```{r, echo=FALSE}
  ggdag_mediation_triangle(x = NULL, y = NULL, m = NULL,
                           x_y_associated = TRUE, edge_type = "link_arc", node_size = 16,
                           text_size = 3.88, label_size = text_size, text_col = "white",
                           label_col = text_col, node = TRUE, stylized = FALSE, text = TRUE,
                           use_labels = NULL) +
    theme_dag()
```
]
.pull-right[

* .blue[Indirect effect] of A on Y through M
* .blue[Direct effect] of A on Y (effect that is not through M)
]

---
# Study Design



* Best to have 3 waves of data:


Exposure -> Mediator -> Outcome



Baseline values of the mediator and outocme can be controlled for as confounders

* Can use cross-sectional data, provided the causal relationships are established

* If there are many waves of data, there are more advanced methods that can deal with this



---

# Standard approach (The difference method)

* Total effect:
$E[Y|A=a,C=c] = \alpha_0 + \alpha_1A + ...$

* Indirect effect:
 $E[Y|A=a,C=c,M=m] = \beta_0 +\beta_1A + ...$


 Direct effect = Total effect - Indierct effect
 
 
---
class: center, inverse , middle
 
# Problem 1: Mediator outcome confounding




---
## Adjusting for M creates collider stratification bias

```{r, echo=FALSE, fig.retina = 3}

pos <- list(x=c(A=0, C1 = 0.125, M= 0.5, U = 1, Y= 1),
            y =c(A=0, C1 = 0.375, M=0.5, U = 0.375, Y = 0))

dag <- dagify( Y ~ A+ M + C1 + U,
                    A ~ C1,
                    M ~ A + U + C1,
               coords = pos,
                   exposure = "A",
                   outcome = "Y")


dag %>% ggdag_dseparated(from = "A", to = "Y",controlling_for = c("M", "C1"),  text = TRUE, collider_lines = TRUE) +
  #  geom_dag_collider_edges() +
  theme_dag() + scale_adjusted()

```


---
class: center, inverse , middle
 
# Problem 2: Exposure-mediator interactions


???

When interaction we would have 2 direct effects (one for each level of the mediator), so it isnt clear how to then work out the indirect effect



---
# Counterfactual framework for mediation

## Some definitions

.content-box-blue[ 
- $Y_a$: counterfafctual outocme when exposure $A$ is set to level $a$
- $M_a$: be the coutnerfactual value of the mediator when  exposure $A$ is set to level $a$
- $Y_{am}$: counterfactual outcome when intervening to set $A$ to $a$ and $M$ to $m$]



---

# Controlled Direct effect (CDE)


.content-box-blue[ CDE : The difference in counterfactual outcomes when $A=1$ compared to $A=0$, when $M$ is fixed at $m$]

$CDE = Y_{1m} - Y_{0m}$

---

# Natural Direct Effect (NDE)

.content-box-blue[ NDE: The effect of comparing treatment level $A=1$ to $A=0$, when intervening to fix $M=M_0$]

$NDE = Y_{1M_0} - Y_{0M_0}$

.content-box-green[ $M_0$: fix the level of the mediator to what it naturally would have  been had the person did not have the exposure]

???

The NDE captures the effect of the exposure if we could disable the path through the mediator

Mediator set to the value it would have been in the abscence of the exposure, c/w CDE where the mediator is fixed at the same value for everybody eg a policy

___

# Natural Indirect Effect (NIE)


.content-box-blue[ NIE: The effect of comparing $M=M_1$ vs $M=M_0$ when  intervening to fix $A=1$]

$NIE = Y_{1M_1} - Y_{1M_0}$


???
The NIE caputes the effect of the exposure on the outcome by changing the mediator

---
# Proportion mediated


PM = NIE/TE


* is imprecise (ie wide confidence intervals)
* USe the CI for the NIE to decide if there is any mediation occuring

---

# Properties of  Direct and Indirect effects

Total effect = NIE + NDE


$Y_1 - Y_0 = Y_{1M_1}- Y_{0M_0}$


---

# Identification: Parametric regression equations




- $E[CDE(m)|c] = E[Y|A=1,m,c] - E[Y|A=0,m,c]$

- $E[NDE|c] = \Sigma_m \{E[Y|A=1,m,c]-E[Y|A=0,m,c]\}P(M=m|A=0,c)$


- $E[NIE|c] = \Sigma_m E[Y|A=1,m,c] \{P(M=m|A=1,c)-P(M=m|A=0,c)\}$


* Fit a regression model for Y, Fit a regression model for M then compute analytically



---
# Monte Carlo Simulation

* For each bootstrap sample:

1. Fit model for M and Y

2. For each treatment level (eg A=0 and 1):
  - simulate a value for M
  - simulate a value for Y conditional on M and the value for A
  -average over these
  
  
Confidence intervals taken from the percentiles form the bootstrapped samples

---

# Assumptions<sup>1,2</sup>

.content-box-blue[
1. No umeasured exposure-outcome confounders
2. No unmeasured mediator-outocme confounders
3. No unmeasured exposure-mediator confounders
4. **There is no mediator-outcome confounder that is affected by exposure**
]

.footnote[
[1] CDE only requires assumptions 1-2.
[2] Randomisation ensures 1 and 3 hold.
]


---
## How do we deal with L?
```{r, echo=FALSE, fig.retina=3}
pos <- list(x=c(A=0, C1 = 0.25, M= 1, U = 2, Y= 2, L = 0.5),
            y =c(A=0, C1 = 0.75, M=1, U = 0.75, Y = 0, L=0.5))

  dag <- dagify( Y ~ A+  M + C1 + U + L,
                      A ~ C1,
                      L ~ A,
                      M ~ A + U + C1,
                 coords = pos,
                     exposure = "A",
                     outcome = "Y")
  
  dag %>% 
     tidy_dagitty() %>%
   ggplot(aes(x = x, y = y, xend = xend, yend = yend)) +
    geom_dag_edges() +
    geom_dag_point() +
    geom_dag_text() +
    theme_dag() +
    scale_adjusted()

```


---
# Comparison to traditional methods


* Provided all confounders are accounted for, they will agree, accept when there is Exposure-MEdiator interaction.

* Fine to drop the interaction term if its magnitude is small, otehrwise include it








---
# Sensitivity analysis





* E-value = RR + sqrt(RR*(RR-1)).

The minimum confounding risk ratio (RR_{UY} and RR_{AU}) that would explain away any effect and its
CI

???
* Too often in RCT's, no thought goes in to measuring all known mediator-outcome confounders
* Sensitivity analysis can help here

---
class: center, middle, inverse

# Thanks


  [**Slides**](https://chrisoldmeadow.github.io/MediationTalk/#1) created via the R package [**xaringan**](https://github.com/yihui/xaringan).
 DAGs created via the R packages [**Dagitty**](https://github.com/jtextor/dagitty)  and [**ggdag**](https://github.com/malcolmbarrett/ggdag)



